<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 { color: #4a5568; font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .header p { color: #718096; font-size: 1.1rem; }
        .sync-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 10px;
        }
        .sync-success { background: #c6f6d5; color: #22543d; }
        .sync-error { background: #fed7d7; color: #742a2a; }
        .sync-loading { background: #bee3f8; color: #2a4365; }
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }
        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #4a5568;
        }
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .nav-tab:hover:not(.active) { background: rgba(102, 126, 234, 0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-number { font-size: 3rem; font-weight: 700; color: #667eea; margin-bottom: 10px; }
        .stat-label { font-size: 1.1rem; color: #4a5568; font-weight: 600; }
        .data-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .table-title { font-size: 1.3rem; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }
        th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            position: sticky;
            top: 0;
        }
        tr:hover { background: rgba(102, 126, 234, 0.05); }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0 2px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .btn-edit { background: #48bb78; color: white; }
        .btn-delete { background: #f56565; color: white; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .action-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
        .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h3 { font-size: 1.5rem; margin-bottom: 10px; color: #4a5568; }
        .empty-state p { margin-bottom: 20px; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            font-weight: 600;
            transition: all 0.3s ease;
            max-width: 300px;
        }
        .notification.success { background: #48bb78; color: white; }
        .notification.warning { background: #ed8936; color: white; }
        .notification.error { background: #f56565; color: white; }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.8rem;
        }
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .nav-tabs { flex-direction: column; }
            table { font-size: 0.8rem; }
            th, td { padding: 10px 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>HR Management System</h1>
            <p>Employee data management with Google Sheets integration</p>
            <div id="syncStatus" class="sync-status sync-loading">üîÑ Connecting to Google Sheets...</div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('employees')">Employees</button>
            <button class="nav-tab" onclick="showTab('debug')">Debug</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div id="dashboardContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <h3>Loading data from Google Sheets...</h3>
                    <p>Please wait while we sync your employee data</p>
                </div>
            </div>
        </div>

        <div id="employees" class="tab-content">
            <div id="employeesContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <h3>Loading employees...</h3>
                    <p>Syncing with Google Sheets</p>
                </div>
            </div>
        </div>

        <div id="debug" class="tab-content">
            <div style="background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 15px;">
                <h3>Debug Information</h3>
                <button class="btn btn-primary" onclick="testConnection()">üîç Test Connection</button>
                <button class="btn btn-success" onclick="loadFromGoogleSheets()">üîÑ Reload Data</button>
                <div id="debugOutput"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let employees = [];
        let sheetsUrl = 'https://script.google.com/macros/s/AKfycbyqoz5kA-az4CbUDwcSr6n1hrcdSX995B8m7LRB01ErXx8lw_c9e3yTNGfqnu8oLim8sg/exec';
        let isSyncing = false;

        // Helper function to safely convert any value to string and trim
        function safeString(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value).trim();
        }

        // Helper function to safely get a property from an object
        function safeGet(obj, ...keys) {
            for (const key of keys) {
                if (obj && obj.hasOwnProperty(key)) {
                    return obj[key];
                }
            }
            return '';
        }

        // Enhanced logging function
        function debugLog(message, data = null) {
            console.log(`[DEBUG] ${message}`, data);
            const debugElement = document.getElementById('debugOutput');
            if (debugElement) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'debug-info';
                logEntry.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
                if (data) {
                    logEntry.innerHTML += `<br><pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>`;
                }
                debugElement.appendChild(logEntry);
                debugElement.scrollTop = debugElement.scrollHeight;
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Application starting...');
            updateSyncStatus('loading', 'üîÑ Connecting to Google Sheets...');
            loadFromGoogleSheets();
        });

        // Update sync status
        function updateSyncStatus(type, message) {
            const statusElement = document.getElementById('syncStatus');
            statusElement.className = `sync-status sync-${type}`;
            statusElement.textContent = message;
            debugLog(`Status: ${message}`);
        }

        // JSONP loader with enhanced error handling
        function loadWithJSONP(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                debugLog(`Starting JSONP request with callback: ${callbackName}`);
                
                window[callbackName] = function(data) {
                    debugLog('JSONP response received', { dataType: typeof data, isArray: Array.isArray(data) });
                    document.head.removeChild(script);
                    delete window[callbackName];
                    resolve(data);
                };
                
                const separator = url.includes('?') ? '&' : '?';
                script.src = url + separator + 'callback=' + callbackName;
                
                script.onerror = function() {
                    debugLog('JSONP script error');
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('JSONP request failed'));
                };
                
                document.head.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        debugLog('JSONP timeout');
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('JSONP request timeout'));
                    }
                }, 15000);
            });
        }

        // Load data with comprehensive error handling and debugging
        async function loadFromGoogleSheets() {
            if (isSyncing) {
                debugLog('Sync already in progress, skipping...');
                return;
            }
            
            isSyncing = true;
            
            try {
                debugLog('Starting data load from Google Sheets');
                updateSyncStatus('loading', 'üîÑ Loading data from Google Sheets...');
                
                let data = null;
                let method = 'unknown';
                
                // Try JSONP method (more reliable for your setup)
                try {
                    debugLog('Attempting JSONP connection...');
                    data = await loadWithJSONP(sheetsUrl);
                    method = 'JSONP';
                    debugLog('JSONP successful', { recordCount: Array.isArray(data) ? data.length : 'not array' });
                } catch (jsonpError) {
                    debugLog('JSONP failed', { error: jsonpError.message });
                    
                    // Fallback to direct fetch
                    try {
                        debugLog('Attempting direct fetch...');
                        const response = await fetch(sheetsUrl, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache'
                        });
                        
                        if (response.ok) {
                            const text = await response.text();
                            data = JSON.parse(text);
                            method = 'direct fetch';
                            debugLog('Direct fetch successful');
                        }
                    } catch (fetchError) {
                        debugLog('Direct fetch failed', { error: fetchError.message });
                    }
                }
                
                if (!data) {
                    throw new Error('All connection methods failed');
                }
                
                debugLog('Raw data received', { 
                    isArray: Array.isArray(data), 
                    length: data.length,
                    firstItemKeys: data[0] ? Object.keys(data[0]) : 'no first item'
                });
                
                if (Array.isArray(data) && data.length > 0) {
                    debugLog('Processing employee data...');
                    
                    // Process each employee with safe string handling
                    employees = data.map((row, index) => {
                        try {
                            debugLog(`Processing employee ${index}`, { name: safeGet(row, 'Name', 'name') });
                            
                            // Safely extract and convert ID
                            let employeeId = safeString(safeGet(row, 'ID', 'id'));
                            if (!employeeId) {
                                employeeId = (100000 + index).toString();
                                debugLog(`Generated ID for employee ${index}: ${employeeId}`);
                            }

                            const employee = {
                                name: safeString(safeGet(row, 'Name', 'name')),
                                id: employeeId,
                                email: safeString(safeGet(row, 'Email', 'email')),
                                department: safeString(safeGet(row, 'Department', 'department')),
                                jobTitle: safeString(safeGet(row, 'Job Title', 'Job title', 'jobTitle')),
                                location: safeString(safeGet(row, 'Location', 'location')),
                                nationality: safeString(safeGet(row, 'Nationality', 'nationality')),
                                status: determineStatus(row),
                                startDate: safeString(safeGet(row, 'Start Date', 'startDate')),
                                endDate: safeString(safeGet(row, 'End Date', 'endDate')),
                                notes: safeString(safeGet(row, 'Notes', 'Note', 'notes'))
                            };
                            
                            return employee;
                        } catch (rowError) {
                            debugLog(`Error processing row ${index}`, { error: rowError.message, row });
                            return null;
                        }
                    }).filter(emp => emp && emp.name); // Filter out null entries and entries without names

                    debugLog(`Successfully processed ${employees.length} employees`);
                    
                    updateInterface();
                    updateSyncStatus('success', `‚úÖ Loaded ${employees.length} employees via ${method}`);
                    showNotification(`Successfully loaded ${employees.length} employees!`, 'success');
                    
                } else {
                    debugLog('No valid data found');
                    updateSyncStatus('error', '‚ö†Ô∏è No data found in Google Sheets');
                    updateInterface();
                }
                
            } catch (error) {
                debugLog('Error in loadFromGoogleSheets', { error: error.message, stack: error.stack });
                console.error('Detailed error:', error);
                updateSyncStatus('error', '‚ùå Failed to connect to Google Sheets');
                showNotification(`Failed to load data: ${error.message}`, 'error');
                updateInterface();
            } finally {
                isSyncing = false;
            }
        }

        // Determine status safely
        function determineStatus(row) {
            try {
                const status = safeString(safeGet(row, 'Status', 'status')).toLowerCase();
                
                if (status === 'active' || status === 'ŸÜÿ¥ÿ∑') return 'active';
                if (status === 'inactive' || status === 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑') return 'inactive';
                
                const endDate = safeString(safeGet(row, 'End Date', 'endDate'));
                if (endDate) {
                    try {
                        const contractEndDate = new Date(endDate);
                        const today = new Date();
                        return contractEndDate >= today ? 'active' : 'inactive';
                    } catch (dateError) {
                        debugLog('Invalid date format', { endDate, error: dateError.message });
                    }
                }
                
                return 'active';
            } catch (error) {
                debugLog('Error determining status', { error: error.message });
                return 'active';
            }
        }

        // Update interface
        function updateInterface() {
            debugLog('Updating interface', { employeeCount: employees.length });
            
            if (employees.length === 0) {
                showEmptyStates();
            } else {
                showDataContent();
                updateDashboard();
                loadEmployeeTable();
            }
        }

        // Show empty states
        function showEmptyStates() {
            document.getElementById('dashboardContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <h3>No Data Available</h3>
                    <p>Check the Debug tab for connection details</p>
                    <button class="btn btn-primary" onclick="loadFromGoogleSheets()">üîÑ Retry Loading</button>
                </div>
            `;

            document.getElementById('employeesContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <h3>No Employees Found</h3>
                    <p>Check the Debug tab for troubleshooting</p>
                    <button class="btn btn-primary" onclick="loadFromGoogleSheets()">üîÑ Retry Loading</button>
                </div>
            `;
        }

        // Show data content
        function showDataContent() {
            // Dashboard
            document.getElementById('dashboardContent').innerHTML = `
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalEmployees">0</div>
                        <div class="stat-label">Total Employees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeEmployees">0</div>
                        <div class="stat-label">Active Employees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalDepartments">0</div>
                        <div class="stat-label">Departments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalJobTitles">0</div>
                        <div class="stat-label">Job Titles</div>
                    </div>
                </div>
            `;

            // Employees table
            document.getElementById('employeesContent').innerHTML = `
                <div class="action-buttons">
                    <button class="action-btn btn-success" onclick="loadFromGoogleSheets()">
                        üîÑ Refresh Data
                    </button>
                </div>
                
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">Employee List (${employees.length} employees)</div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Job Title</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Update dashboard stats
        function updateDashboard() {
            try {
                const activeEmployees = employees.filter(emp => emp.status === 'active').length;
                const departments = [...new Set(employees.map(emp => emp.department).filter(d => d))];
                const jobTitles = [...new Set(employees.map(emp => emp.jobTitle).filter(j => j))];
                
                document.getElementById('totalEmployees').textContent = employees.length;
                document.getElementById('activeEmployees').textContent = activeEmployees;
                document.getElementById('totalDepartments').textContent = departments.length;
                document.getElementById('totalJobTitles').textContent = jobTitles.length;
                
                debugLog('Dashboard updated', {
                    total: employees.length,
                    active: activeEmployees,
                    departments: departments.length,
                    jobTitles: jobTitles.length
                });
            } catch (error) {
                debugLog('Error updating dashboard', { error: error.message });
            }
        }

        // Load employee table
        function loadEmployeeTable() {
            try {
                const tbody = document.getElementById('employeeTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                employees.forEach((emp, index) => {
                    const row = document.createElement('tr');
                    const statusBadge = emp.status === 'active' ? 
                        '<span style="background: #c6f6d5; color: #22543d; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">Active</span>' : 
                        '<span style="background: #fed7d7; color: #742a2a; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">Inactive</span>';
                    
                    row.innerHTML = `
                        <td>${emp.id || '-'}</td>
                        <td>${emp.name || '-'}</td>
                        <td>${emp.department || '-'}</td>
                        <td>${emp.jobTitle || '-'}</td>
                        <td>${statusBadge}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                debugLog('Employee table loaded', { rowCount: employees.length });
            } catch (error) {
                debugLog('Error loading employee table', { error: error.message });
            }
        }

        // Show tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            debugLog(`Switched to tab: ${tabName}`);
        }

        // Test connection function
        async function testConnection() {
            debugLog('Manual connection test started');
            await loadFromGoogleSheets();
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const existing = document.querySelectorAll('.notification');
            existing.forEach(notif => notif.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Initialize debug output
        document.addEventListener('DOMContentLoaded', function() {
            const debugOutput = document.getElementById('debugOutput');
            if (debugOutput) {
                debugOutput.innerHTML = '<div class="debug-info"><strong>Debug Log Started</strong></div>';
            }
        });

        debugLog('HR Management System initialized');
    </script>
</body>
</html>
